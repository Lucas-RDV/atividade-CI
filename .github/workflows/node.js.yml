name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install dependencies
      run: npm install

    - name: Run unit tests (no container)
      run: npm test

    - name: Build Docker image
      run: docker build -t meu-app .

    - name: Run docker compose up -d
      run: docker compose up -d

    - name: Wait for container to be healthy
      run: |
        echo "Aguardando app iniciar..."
        sleep 10
        docker ps -a

    - name: Test container endpoint
      run: |
        curl --fail http://localhost:3000/api/funcionarios || exit 1

    - name: Shutdown containers
      run: docker compose down

    - name: Validate Docker Hub secrets
      run: |
        if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
          echo "ERROR: Secret DOCKERHUB_USERNAME está vazio"; exit 1; fi
        if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo "ERROR: Secret DOCKERHUB_TOKEN está vazio"; exit 1; fi
        echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/atividade-ci" >> $GITHUB_ENV
        echo "Usando tag: ${{ secrets.DOCKERHUB_USERNAME }}/atividade-ci"

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and Push image to Docker Hub
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ./Dockerfile  
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/atividade-ci:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/atividade-ci:${{ github.sha }}
        